LOKI URL TO TRY ON DATA SOURCE:  http://loki.logging.svc.cluster.local:3100


How to install ?
Add the Grafana repository first
helm repo add grafana https://grafana.github.io/helm-charts
2. Update your repository

helm repo update
3. Add the loki-grafana-values.yaml file with the below configuration.

filebeat:
  enabled: false
  filebeatConfig:
    filebeat.yml: |
      # logging.level: debug
      filebeat.inputs:
      - type: container
        paths:
          - /var/log/containers/*.log
        processors:
        - add_kubernetes_metadata:
            host: ${NODE_NAME}
            matchers:
            - logs_path:
                logs_path: "/var/log/containers/"
      output.logstash:
        hosts: ["logstash-loki:5044"]
fluent-bit:
  enabled: false
grafana:
  enabled: true
  image:
    tag: 9.0.2
  persistence:
    enabled: true
    size: 3Gi
    storageClassName: gp2
  sidecar:
    datasources:
      enabled: true
  #nodeSelector:
    #role: nodes-dev-general    
logstash:
  enabled: false
  filters:
    main: |-
      filter {
        if [kubernetes] {
          mutate {
            add_field => {
              "container_name" => "%{[kubernetes][container][name]}"
              "namespace" => "%{[kubernetes][namespace]}"
              "pod" => "%{[kubernetes][pod][name]}"
            }
            replace => { "host" => "%{[kubernetes][node][name]}"}
          }
        }
        mutate {
          remove_field => ["tags"]
        }
      }
  image: grafana/logstash-output-loki
  imageTag: 1.0.1
  outputs:
    main: |-
      output {
        loki {
          url => "http://loki:3100/loki/api/v1/push"
          #username => "test"
          #password => "test"
        }
        # stdout { codec => rubydebug }
      }
loki:
  config:
    compactor:
      compaction_interval: 10m
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
      retention_enabled: true
      working_directory: /data/retention
    limits_config:
      retention_period: 72h
  enabled: true
  isDefault: true
  persistence:
    enabled: true
    size: 5Gi
    storageClassName: gp2
  #nodeSelector:
    #role: nodes-dev-general  
prometheus:
  enabled: false
  isDefault: false
promtail:
  config:
    lokiAddress: http://{{ .Release.Name }}:3100/loki/api/v1/push
  enabled: true
  #nodeSelector:
    #role: nodes-dev-general
Note -

Change the grafana volume size as per your need.
Change the loki retention period to the days you want to store the logs for.
Change the loki volume size as per your retention period.
4. Install LOKI with the loki-grafana-values.yaml file .

helm upgrade --install loki --namespace=monitoring --values loki-grafana-values.yaml grafana/loki-stack
5. Change the namespace as per you requirement.

6. This helm upgrade command will deploy the loki into your cluster -

i) This will create 1 loki stateful set , loki-promtail daemon set and 1 loki-grafana pods.


ii) This will create 2 pvc — 1 for grafana and 1 for loki.


7. With the help of port-forwarding forward the loki-grafana service and check if the login page is available. It should look like -


8. You can get the password from the secret loki-grafana and default user is admin. Then you can log in to grafana dashboard.


9. Add the loki datasource -

In the left side , go to the configuration and then datasources.

Add the datasource loki and add the url — http://loki:3100.
10. In the left upper corner , click explore , select loki as datasource and select log browser.

11. You can choose the labels and values you need to see the logs off.

12. You can only see the number of pods those are having logs in the selected timespan.